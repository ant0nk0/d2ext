var d2 = {
    version: "0.1.2",
    rootUrl: "http://www.drive2.ru/",
    feedUrl: "my/feed/",
    talksUrl: "my/talks/",
    messagerUrl: "ajax/messenger.cshtml",
    onClickUrl: "",
    fctx: "",
    amet: "",
    originalName: "",
    updateAfterLoadTimeout: 0,

    checkFeed: function () {
        if (window.jQuery == undefined)
            return;

        jQuery.support.cors = true;
        jQuery.ajax({
            type: "POST",
            url: d2.rootUrl + d2.messagerUrl,
            data: d2.fctx + "&" + d2.amet + "&_=update",
            contentType: "application/x-www-form-urlencoded;charset=UTF-8",
            crossDomain: true,
            success: function (b) {
                var jsonResult = jQuery.parseJSON(b);
                var jsonFeed = jsonResult["feedHtml"];
                var jsonTalk = jsonResult["html"];

                var doc = document.implementation.createHTMLDocument("");
                doc.body.innerHTML = jsonFeed;
                var messagesCount = 0;
                var title = "";

                var feedItems = doc.getElementsByTagName('a');
                if (feedItems.length > 1)
                {
                    messagesCount += parseInt(feedItems[1].innerHTML);
                    title += chrome.i18n.getMessage("feed") + " " + messagesCount;
                    d2.onClickUrl = d2.rootUrl + d2.feedUrl;
                }

                doc.body.innerHTML = jsonTalk;
                var talkItems = doc.getElementsByTagName('a');
                if (talkItems.length > 1)
                {
                    var talksCount = parseInt(talkItems[1].innerHTML);
                    messagesCount += talksCount;

                    if (title != "")
                        title += title + ", ";
                    title += chrome.i18n.getMessage("talks") + " " + talksCount;

                    d2.onClickUrl = d2.rootUrl + d2.talksUrl;
                }

                chrome.browserAction.setTitle({"title": title != "" ? d2.originalName + " - " + title : d2.originalName });
                chrome.browserAction.setBadgeText({ "text": messagesCount == 0 ? "" : messagesCount.toString() });
            },
            error: function () {
                chrome.browserAction.setBadgeText({ "text": "err" });
            }
        })   
    },

    startCheck: function () {
        if (window.jQuery == undefined)
            return;

        chrome.browserAction.getTitle({}, function(result){ d2.originalName = result; });
        d2.onClickUrl = d2.rootUrl + d2.feedUrl;
        chrome.browserAction.onClicked.addListener(d2.onClickedHandler);

        jQuery.support.cors = true;
        jQuery.ajax({
            type: "GET",
            url: d2.rootUrl,
            crossDomain: true,
            success: function (b) {
                    var sessionHashes = b.match(/d2.__fctx=\[(.*)\]/);
                    sessionHashes = sessionHashes[1].replace(/"/g,"");
                    sessionHashes = sessionHashes.split(',');

                    d2.fctx = sessionHashes[0] + "=" + sessionHashes[1];
                    d2.amet = sessionHashes[2] + "=" + sessionHashes[3];

                    d2.checkFeed();
                    setInterval(d2.checkFeed, localStorage.requestInterval*1000);
                },
                error: function () {
                    chrome.browserAction.setBadgeText({ "text": "err" });
                }
            })
    },

    updateAfterLoad: function () {
        d2.checkFeed();
        clearTimeout(d2.updateAfterLoadTimeout);
        d2.updateAfterLoadTimeout = 0;
    },

    onClickedHandler: function () {
        var g = d2.onClickUrl;

        chrome.windows.getAll({
            populate: true
        }, function (q) {
            var r = null;
            for (var o in q) {
                var n = q[o].tabs;
                for (var m in n) {
                    var p = n[m];
                    if (p.url == g) {
                        r = p;
                        break
                    }
                }
            }
            if (r) {
                chrome.tabs.update(r.id, {
                    selected: true
                })
            } else {
                chrome.tabs.create({
                    url: g,
                    selected: true
                })
            }

            d2.updateAfterLoadTimeout = setTimeout(d2.updateAfterLoad, localStorage.updateAfterOpen*1000);            
        })
    }
};
